---
title: "Combine data into states.rds"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages({
  library("tidyverse")
  library("states")
})

# shortcut for plotting missing values when no date column is available
plotmiss <- function(x) {
  plot_missing(x, names(x), partial = "any")
}
```

## Pieces

### Master statelist

```{r}
states <- state_panel(1950, 2019, partial = "any")
```

### P&T coups

```{r}
ptcoups <- read_csv("input/ptcoups.csv")

glimpse(ptcoups)

plotmiss(ptcoups)

states <- left_join(states, ptcoups, by = c("gwcode", "year"))
```

### Make lead DV versions

```{r}
dv_vars <- ptcoups %>%
  select(gwcode, year, pt_attempt, pt_coup, pt_failed) 
lead1 <- dv_vars %>%
  mutate(year = year - 1) %>%
  rename(pt_attempt_lead1 = pt_attempt, pt_coup_lead1 = pt_coup, 
         pt_failed_lead1 = pt_failed)
lead2 <- dv_vars %>%
  mutate(year = year - 2) %>%
  rename(pt_attempt_lead2 = pt_attempt, pt_coup_lead2 = pt_coup, 
         pt_failed_lead2 = pt_failed)
dv <- full_join(lead1, lead2)
```

Cuba had an attempt in 1952, check data are correct for this:

```{r}
cuba <- dv %>%
  filter(gwcode==40 & year < 1953) %>%
  arrange(year) %>%
  select(gwcode, year, pt_coup_lead1, pt_coup_lead2)

cuba

stopifnot(cuba$pt_coup_lead1[cuba$year==1951] == 1,
          cuba$pt_coup_lead2[cuba$year==1950] == 1)
```

#### Impute for last 2 years in state existence

Several states drop out during the data period. Set the DV vars to 0 in those instances.

```{r}
last2 <- function(x, yy, ly) {
  ifelse(is.na(x) & yy >= ly - 1, 0L, x)
}

dv_full <- left_join(states, dv) %>%
  select(gwcode, year, contains("lead")) %>%
  group_by(gwcode) %>%
  mutate(last_year = max(year),
         # states with last year in 2019 still exist
         last_year = ifelse(last_year==max(states$year), 9999L, last_year)) %>%
  mutate_at(.vars = vars(contains("lead")), ~last2(., year, last_year)) %>%
  select(-last_year)
```

```{r}
states <- left_join(states, dv_full)
```

## G&W state age

Years since independence

```{r}
age <- read_csv("input/gwstate-age.csv") %>%
  mutate(ln_state_age = log(state_age)) %>%
  select(-state_age)

states <- left_join(states, age, by = c("gwcode", "year"))
```

## EPR

Ethnic Power Relations data on ethnic groups in countries.

```{r}
epr <- read_csv("input/epr.csv") %>%
  setNames(c("gwcode", "year", paste0("epr_", names(.)[3:ncol(.)])))

glimpse(epr)
```

Add year-to-year difference of these variables. Changes could be significant. 

```{r, eval=FALSE}
TODO
```


EPR only ranges to 2017 right now. Lag and carry-back, or don't lag but do carry-forward from 2017 on?

```{r}
ggplot(epr, aes(x = year, y = epr_excluded_group_pop, group = gwcode)) +
  geom_line()
```

There are quite frequent changes, as the plot above shows. Since I care more about recent cases, and since it seems fair to assume that the power structures pre-independence were similar to those at independence, lag and carry back for first two years in state's existence, for states that enter after 1950. 

```{r}
epr_lagged <- epr %>%
  mutate(year = year + 2) %>%
  arrange(gwcode, year) %>%
  group_by(gwcode) %>%
  tidyr::fill(-gwcode, -year, .direction = "up")
```

```{r}
states <- left_join(states, epr_lagged, by = c("gwcode", "year"))
```


## Summarize and write output

```{r final-missplot}
plotmiss(states)
```

Write all incomplete cases to a CSV so changes introduced by something in one of the input datasets is easier to notice:

```{r}
format_years <- function(x) {
  if (length(x) > 1) {
    return(paste(range(x), collapse = " - "))
  }
  as.character(x)
}

incomplete_cases <- states %>%
  gather(var, value, -gwcode, -year) %>%
  mutate(dv_var = str_detect(var, "lead[0-9]{1}")) %>%
  filter( 
    # for non-DV vars, take any missing values
    (!dv_var & is.na(value)) | 
      # for DV vars, last 2 years are missing by design
      (dv_var & is.na(value) & year < max(states$year) - 1)) %>%
  group_by(gwcode, year, var) %>%
  summarize() %>%
  # summarize which vars are missing
  group_by(gwcode, year) %>%
  summarize(missing_values_in = paste0(var, collapse = ", ")) 

# if there are no missing cases, stop; otherwise 
# add in year sequences ID so we can collapse adjacent years with same 
# missing var
if (nrow(incomplete_cases) > 0) {
  incomplete_cases <- incomplete_cases %>%
    group_by(gwcode) %>%
    arrange(year) %>%
    mutate(date = as.Date(paste0(year, "-01-01")),
           yr_id = id_date_sequence(date, "year")) %>%
    group_by(gwcode, yr_id, missing_values_in) %>%
    summarize(years = format_years(year)) %>%
    # clean up
    ungroup() %>%
    select(gwcode, years, missing_values_in) %>%
    arrange(years, gwcode)
}

  
write_csv(incomplete_cases, "output/incomplete-cases.csv")
```

### Variables in data

```{r variables}
var_summary <- states %>%
  pivot_longer(everything(), names_to = "variable") %>%
  group_by(variable) %>%
  summarize(missing = sum(is.na(value)),
            sd = sd(value, na.rm = TRUE),
            integer = isTRUE(all.equal(value, as.integer(value))),
            unique_val_ratio = length(unique(value))/length(value))

write_csv(var_summary, "output/variables.csv")

knitr::kable(var_summary, digits = 2)
```


### Missing values by column

```{r summarize-missing-value}
sapply(states, function(x) sum(is.na(x))) %>%
  as.list() %>%
  tibble::enframe(name = "Variable", value = "Missing") %>%
  unnest(Missing) %>%
  filter(Missing > 0) %>%
  knitr::kable()
```

## Take out incomplete rows and save

```{r}
states_clean <- states %>%
  filter(!is.na(epr_groups))
write_rds(states_clean, "output/states.rds")
```


